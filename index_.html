<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel ARG Â· Mercado</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
:root {
  --bg: #0a0d12;
  --surface: #111520;
  --surface2: #161b26;
  --border: #1e2535;
  --border2: #252d40;
  --text: #e2e8f0;
  --muted: #5a6a85;
  --muted2: #8899aa;
  --accent: #3b82f6;
  --accent2: #1d4ed8;
  --green: #22c55e;
  --red: #ef4444;
  --yellow: #f59e0b;
  --mono: 'IBM Plex Mono', monospace;
  --sans: 'IBM Plex Sans', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

/* TOPBAR */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(10,13,18,0.92);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  display: flex; align-items: center; gap: 20px;
  height: 52px;
}
.topbar-logo {
  font-family: var(--mono); font-size: 0.85rem; font-weight: 600;
  color: var(--accent); letter-spacing: 0.1em; text-transform: uppercase;
  white-space: nowrap;
}
.topbar-sep { width: 1px; height: 20px; background: var(--border2); }
.topbar-sentiment {
  font-family: var(--mono); font-size: 0.75rem;
  padding: 3px 10px; border-radius: 4px;
  border: 1px solid; white-space: nowrap;
}
.topbar-meta {
  margin-left: auto; font-family: var(--mono); font-size: 0.7rem; color: var(--muted);
  white-space: nowrap;
}
.topbar-search {
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 6px; padding: 5px 12px;
  color: var(--text); font-family: var(--mono); font-size: 0.78rem;
  width: 160px; outline: none;
  transition: border-color 0.2s, width 0.3s;
}
.topbar-search:focus { border-color: var(--accent); width: 220px; }
.topbar-search::placeholder { color: var(--muted); }

/* LAYOUT */
.wrap { max-width: 1440px; margin: 0 auto; padding: 28px 28px 80px; }

/* KPI ROW */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px; margin-bottom: 24px;
}
.kpi {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; padding: 16px 18px;
  transition: border-color 0.2s;
}
.kpi:hover { border-color: var(--border2); }
.kpi-label {
  font-family: var(--mono); font-size: 0.65rem; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--muted); margin-bottom: 8px;
}
.kpi-val {
  font-family: var(--mono); font-size: 1.6rem; font-weight: 600; line-height: 1;
}
.kpi-val.pos { color: var(--green); }
.kpi-val.neg { color: var(--red); }
.kpi-val.neu { color: var(--text); }
.kpi-val.acc { color: var(--accent); }

/* SUMMARY */
.summary {
  background: var(--surface); border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: 8px; padding: 16px 20px; margin-bottom: 24px;
  font-size: 0.85rem; color: var(--muted2); line-height: 1.7;
}
.summary-label {
  font-family: var(--mono); font-size: 0.65rem; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--accent); margin-bottom: 8px;
}

/* SECTION TITLE */
.section-title {
  font-family: var(--mono); font-size: 0.7rem; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--muted); margin-bottom: 12px;
  display: flex; align-items: center; gap: 10px;
}
.section-title::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* CARDS */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden; margin-bottom: 20px;
}
.card-head {
  padding: 14px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
}
.card-title { font-size: 0.88rem; font-weight: 600; }
.card-badge {
  margin-left: auto; font-family: var(--mono); font-size: 0.65rem;
  color: var(--muted); background: var(--surface2);
  border: 1px solid var(--border2); border-radius: 4px; padding: 2px 8px;
}
.card-body { padding: 16px 20px; }

/* GRID */
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

/* HEATMAP GRID */
.heatmap-grid {
  display: flex; flex-wrap: wrap; gap: 6px; padding: 16px 20px;
}
.hm-cell {
  border-radius: 6px; padding: 8px 10px; cursor: pointer;
  transition: transform 0.15s, filter 0.15s;
  min-width: 72px; text-align: center;
  border: 1px solid transparent;
  user-select: none;
}
.hm-cell:hover { transform: scale(1.06); filter: brightness(1.2); border-color: rgba(255,255,255,0.2); }
.hm-ticker { font-family: var(--mono); font-size: 0.72rem; font-weight: 600; }
.hm-ret { font-family: var(--mono); font-size: 0.7rem; margin-top: 2px; }

/* TABLE */
.tbl-wrap { overflow-x: auto; }
table {
  width: 100%; border-collapse: collapse;
  font-family: var(--mono); font-size: 0.78rem;
}
th {
  background: var(--surface2); color: var(--muted);
  font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em;
  padding: 10px 14px; text-align: right; border-bottom: 1px solid var(--border);
  cursor: pointer; user-select: none; white-space: nowrap;
}
th:first-child { text-align: left; }
th:hover { color: var(--text); }
td {
  padding: 9px 14px; border-bottom: 1px solid var(--border);
  text-align: right; white-space: nowrap; color: var(--muted2);
  transition: background 0.1s;
}
td:first-child { text-align: left; color: var(--text); }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--surface2); cursor: pointer; }
.pos { color: var(--green) !important; }
.neg { color: var(--red) !important; }
.ticker-link { font-weight: 600; color: var(--accent) !important; }

/* MODAL */
.modal-overlay {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.75); backdrop-filter: blur(4px);
  align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 12px; width: 92vw; max-width: 960px;
  max-height: 90vh; overflow: hidden;
  display: flex; flex-direction: column;
  animation: modalIn 0.2s ease;
}
@keyframes modalIn {
  from { opacity: 0; transform: translateY(16px) scale(0.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.modal-head {
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 14px;
}
.modal-ticker { font-family: var(--mono); font-size: 1.2rem; font-weight: 600; color: var(--accent); }
.modal-price { font-family: var(--mono); font-size: 1rem; color: var(--text); }
.modal-ret { font-family: var(--mono); font-size: 0.85rem; font-weight: 600; }
.modal-close {
  margin-left: auto; background: none; border: 1px solid var(--border2);
  color: var(--muted); font-size: 1.1rem; width: 30px; height: 30px;
  border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s;
}
.modal-close:hover { background: var(--surface2); color: var(--text); }
.modal-tabs {
  display: flex; gap: 0; border-bottom: 1px solid var(--border); padding: 0 20px;
}
.modal-tab {
  font-family: var(--mono); font-size: 0.72rem; text-transform: uppercase;
  letter-spacing: 0.08em; padding: 10px 16px; cursor: pointer;
  color: var(--muted); border-bottom: 2px solid transparent;
  transition: color 0.15s, border-color 0.15s;
}
.modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.modal-body { flex: 1; overflow: auto; padding: 4px; }
#modal-chart { min-height: 420px; }

/* CHART CONTAINERS */
.chart-container { min-height: 320px; }

/* RANGE BUTTONS */
.range-btns {
  display: flex; gap: 6px; padding: 12px 20px 0;
}
.range-btn {
  font-family: var(--mono); font-size: 0.68rem; padding: 4px 10px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 4px; color: var(--muted); cursor: pointer;
  transition: all 0.15s;
}
.range-btn:hover, .range-btn.active { background: var(--accent2); border-color: var(--accent); color: #fff; }

/* LOADING */
.loading {
  display: flex; align-items: center; justify-content: center;
  height: 300px; font-family: var(--mono); font-size: 0.8rem; color: var(--muted);
  gap: 10px;
}
.spinner {
  width: 18px; height: 18px; border: 2px solid var(--border2);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* FOOTER */
.footer {
  text-align: center; margin-top: 60px;
  font-family: var(--mono); font-size: 0.68rem; color: var(--muted);
}

/* SEARCH RESULTS */
.search-results {
  position: absolute; top: 52px; left: 0; right: 0;
  background: var(--surface); border-bottom: 1px solid var(--border);
  z-index: 99; display: none; flex-wrap: wrap; gap: 6px; padding: 12px 28px;
}
.search-results.open { display: flex; }
.search-tag {
  font-family: var(--mono); font-size: 0.72rem;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 4px; padding: 4px 10px; cursor: pointer;
  color: var(--muted2); transition: all 0.15s;
}
.search-tag:hover { border-color: var(--accent); color: var(--accent); }

@media (max-width: 900px) {
  .kpi-row { grid-template-columns: repeat(3, 1fr); }
  .grid2 { grid-template-columns: 1fr; }
  .wrap { padding: 16px 14px 60px; }
  .topbar { padding: 0 14px; }
}
@media (max-width: 560px) {
  .kpi-row { grid-template-columns: repeat(2, 1fr); }
  .topbar-search { width: 110px; }
}
</style>
</head>
<body>

<div id="topbar" class="topbar">
  <span class="topbar-logo">â–ª Panel ARG</span>
  <div class="topbar-sep"></div>
  <span id="topbar-sentiment" class="topbar-sentiment"></span>
  <input type="text" class="topbar-search" id="search" placeholder="Buscar ticker..." autocomplete="off">
  <span id="topbar-meta" class="topbar-meta"></span>
</div>

<div id="search-results" class="search-results"></div>

<div class="wrap">
  <div id="loading" class="loading"><div class="spinner"></div> Cargando datos...</div>

  <div id="app" style="display:none">

    <div class="kpi-row" id="kpi-row"></div>

    <div class="summary" id="summary"></div>

    <div class="section-title">Mapa de variaciones</div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-head">
        <span class="card-title">Heatmap</span>
        <span class="card-badge" id="hm-badge"></span>
      </div>
      <div id="heatmap-grid" class="heatmap-grid"></div>
    </div>

    <div class="section-title">DistribuciÃ³n</div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-head"><span class="card-title">Histograma de retornos diarios</span></div>
      <div class="card-body">
        <div id="hist-chart" class="chart-container"></div>
      </div>
    </div>

    <div class="section-title">Ranking</div>
    <div class="grid2">
      <div class="card">
        <div class="card-head">
          <span class="card-title">ðŸŸ¢ Top Ganadores</span>
          <span class="card-badge">click para ver velas</span>
        </div>
        <div class="tbl-wrap"><table id="tbl-gainers"><thead></thead><tbody></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-head">
          <span class="card-title">ðŸ”´ Top Perdedores</span>
          <span class="card-badge">click para ver velas</span>
        </div>
        <div class="tbl-wrap"><table id="tbl-losers"><thead></thead><tbody></tbody></table></div>
      </div>
    </div>

    <div class="section-title">Panel completo</div>
    <div class="card">
      <div class="card-head">
        <span class="card-title">Todos los instrumentos</span>
        <span class="card-badge" id="full-badge"></span>
      </div>
      <div class="tbl-wrap"><table id="tbl-full"><thead></thead><tbody></tbody></table></div>
    </div>

    <div class="footer" id="footer"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-ticker" id="modal-ticker"></span>
      <span class="modal-price" id="modal-price"></span>
      <span class="modal-ret" id="modal-ret"></span>
      <button class="modal-close" id="modal-close">âœ•</button>
    </div>
    <div class="modal-tabs">
      <div class="modal-tab active" data-tab="candles">Velas</div>
      <div class="modal-tab" data-tab="volume">Volumen</div>
      <div class="modal-tab" data-tab="returns">Retornos</div>
    </div>
    <div class="range-btns" id="range-btns">
      <button class="range-btn" data-days="30">1M</button>
      <button class="range-btn" data-days="90">3M</button>
      <button class="range-btn" data-days="180">6M</button>
      <button class="range-btn active" data-days="365">1A</button>
      <button class="range-btn" data-days="1095">3A</button>
      <button class="range-btn" data-days="99999">Todo</button>
    </div>
    <div class="modal-body">
      <div id="modal-chart"></div>
    </div>
  </div>
</div>

<script>
let DATA = null;
let currentTicker = null;
let currentDays = 365;
let currentTab = 'candles';

const PLOTLY_LAYOUT_BASE = {
  paper_bgcolor: '#111520', plot_bgcolor: '#111520',
  font: { family: 'IBM Plex Mono', color: '#8899aa', size: 11 },
  margin: { t: 20, r: 20, b: 40, l: 60 },
  xaxis: { gridcolor: '#1e2535', linecolor: '#1e2535', tickfont: { size: 10 } },
  yaxis: { gridcolor: '#1e2535', linecolor: '#1e2535', tickfont: { size: 10 } },
};

function heatColor(v) {
  if (v > 4)  return { bg: '#14532d', text: '#4ade80' };
  if (v > 2)  return { bg: '#166534', text: '#86efac' };
  if (v > 0.5) return { bg: '#15803d44', text: '#22c55e' };
  if (v > -0.5) return { bg: '#1e2535', text: '#8899aa' };
  if (v > -2) return { bg: '#7f1d1d44', text: '#f87171' };
  if (v > -4) return { bg: '#991b1b', text: '#fca5a5' };
  return { bg: '#7f1d1d', text: '#fecaca' };
}

function fmt(v, dec=2) { return v.toFixed(dec); }
function fmtK(v) {
  if (v >= 1e9) return (v/1e9).toFixed(1) + 'B';
  if (v >= 1e6) return (v/1e6).toFixed(1) + 'M';
  if (v >= 1e3) return (v/1e3).toFixed(0) + 'K';
  return v.toString();
}

async function loadData() {
  const r = await fetch('data.json?' + Date.now());
  DATA = await r.json();
  render();
}

function render() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';

  const s = DATA.market_summary;
  const tickers = DATA.tickers;

  // Topbar
  const sentEl = document.getElementById('topbar-sentiment');
  sentEl.textContent = s.sentiment;
  const isPos = s.ad_ratio >= 1;
  sentEl.style.color = isPos ? 'var(--green)' : 'var(--red)';
  sentEl.style.borderColor = isPos ? '#166534' : '#7f1d1d';
  sentEl.style.background = isPos ? '#14532d33' : '#7f1d1d33';
  document.getElementById('topbar-meta').textContent = `Actualizado: ${DATA.generated_at}`;

  // KPIs
  const kpis = [
    { label: 'Total', val: s.total_stocks, cls: 'acc' },
    { label: 'Alcistas', val: s.advances, cls: 'pos' },
    { label: 'Bajistas', val: s.declines, cls: 'neg' },
    { label: 'Ratio A/D', val: fmt(s.ad_ratio), cls: s.ad_ratio >= 1 ? 'pos' : 'neg' },
    { label: 'Promedio', val: (s.avg_change >= 0 ? '+' : '') + fmt(s.avg_change) + '%', cls: s.avg_change >= 0 ? 'pos' : 'neg' },
    { label: 'Mediana', val: (s.median_change >= 0 ? '+' : '') + fmt(s.median_change) + '%', cls: s.median_change >= 0 ? 'pos' : 'neg' },
  ];
  document.getElementById('kpi-row').innerHTML = kpis.map(k =>
    `<div class="kpi"><div class="kpi-label">${k.label}</div><div class="kpi-val ${k.cls}">${k.val}</div></div>`
  ).join('');

  // Summary
  document.getElementById('summary').innerHTML =
    `<div class="summary-label">Resumen ejecutivo</div>${s.executive_summary}`;

  // Heatmap
  const sorted = [...tickers].sort((a,b) => b.daily_ret - a.daily_ret);
  document.getElementById('hm-badge').textContent = `${tickers.length} instrumentos`;
  document.getElementById('heatmap-grid').innerHTML = sorted.map(t => {
    const c = heatColor(t.daily_ret);
    const sign = t.daily_ret >= 0 ? '+' : '';
    return `<div class="hm-cell" style="background:${c.bg};color:${c.text}" 
      onclick="openModal('${t.ticker}')" title="${t.ticker}: ${sign}${fmt(t.daily_ret)}%">
      <div class="hm-ticker">${t.ticker}</div>
      <div class="hm-ret">${sign}${fmt(t.daily_ret)}%</div>
    </div>`;
  }).join('');

  // Histogram
  renderHistogram(tickers);

  // Tables
  const gainers = [...tickers].sort((a,b) => b.daily_ret - a.daily_ret).slice(0, 15);
  const losers  = [...tickers].sort((a,b) => a.daily_ret - b.daily_ret).slice(0, 15);
  renderTable('tbl-gainers', gainers);
  renderTable('tbl-losers',  losers);
  renderTable('tbl-full',    [...tickers].sort((a,b) => b.daily_ret - a.daily_ret), true);
  document.getElementById('full-badge').textContent = `${tickers.length} instrumentos`;

  // Footer
  document.getElementById('footer').textContent = `datos: data912.com Â· ${DATA.generated_at} Â· solo con fines informativos`;
}

function renderHistogram(tickers) {
  const rets = tickers.map(t => t.daily_ret);
  const pos = rets.filter(r => r > 0);
  const neg = rets.filter(r => r < 0);
  const neu = rets.filter(r => r === 0);

  Plotly.newPlot('hist-chart', [
    { x: neg, type: 'histogram', name: 'Bajistas', marker: { color: '#ef4444aa' }, nbinsx: 20 },
    { x: neu, type: 'histogram', name: 'Sin cambio', marker: { color: '#5a6a85aa' }, nbinsx: 5 },
    { x: pos, type: 'histogram', name: 'Alcistas', marker: { color: '#22c55eaa' }, nbinsx: 20 },
    { x: [DATA.market_summary.avg_change], y: [0], type: 'scatter', mode: 'markers+text',
      name: 'Promedio', marker: { color: '#3b82f6', size: 10, symbol: 'line-ns', line: { width: 2, color: '#3b82f6' }},
      text: [`  Î¼ ${fmt(DATA.market_summary.avg_change)}%`], textposition: 'middle right',
      textfont: { color: '#3b82f6', size: 10 } },
  ], {
    ...PLOTLY_LAYOUT_BASE,
    height: 260,
    barmode: 'overlay',
    showlegend: true,
    legend: { orientation: 'h', y: 1.1, font: { size: 10 }, bgcolor: 'transparent' },
    xaxis: { ...PLOTLY_LAYOUT_BASE.xaxis, title: { text: 'Retorno %', font: { size: 10 } } },
    yaxis: { ...PLOTLY_LAYOUT_BASE.yaxis, title: { text: 'NÂº acciones', font: { size: 10 } } },
  }, { displayModeBar: false, responsive: true });
}

const TABLE_HEADERS = ['Ticker', 'Precio', 'Cambio %', 'Volumen', 'Vol Rel'];
function renderTable(id, data, sortable = false) {
  const tbl = document.getElementById(id);
  tbl.querySelector('thead').innerHTML = `<tr>${TABLE_HEADERS.map((h,i) =>
    `<th onclick="sortTable('${id}',${i})">${h}</th>`).join('')}</tr>`;
  tbl.querySelector('tbody').innerHTML = data.map(t => {
    const sign = t.daily_ret >= 0 ? '+' : '';
    const cls  = t.daily_ret > 0 ? 'pos' : t.daily_ret < 0 ? 'neg' : '';
    return `<tr onclick="openModal('${t.ticker}')">
      <td><span class="ticker-link">${t.ticker}</span></td>
      <td>$${fmt(t.close_last)}</td>
      <td class="${cls}">${sign}${fmt(t.daily_ret)}%</td>
      <td>${fmtK(t.volume_last)}</td>
      <td>${fmt(t.vol_rel20)}x</td>
    </tr>`;
  }).join('');
}

function sortTable(id, colIdx) {
  const tbl = document.getElementById(id);
  const rows = Array.from(tbl.querySelectorAll('tbody tr'));
  const asc = tbl.dataset.sortCol == colIdx && tbl.dataset.sortDir == 'asc';
  rows.sort((a, b) => {
    const av = a.cells[colIdx].textContent.replace(/[^0-9.-]/g,'');
    const bv = b.cells[colIdx].textContent.replace(/[^0-9.-]/g,'');
    const an = parseFloat(av), bn = parseFloat(bv);
    const cmp = isNaN(an) ? av.localeCompare(bv) : an - bn;
    return asc ? -cmp : cmp;
  });
  rows.forEach(r => tbl.querySelector('tbody').appendChild(r));
  tbl.dataset.sortCol = colIdx;
  tbl.dataset.sortDir = asc ? 'desc' : 'asc';
}

// SEARCH
document.getElementById('search').addEventListener('input', function() {
  const q = this.value.trim().toUpperCase();
  const resultsEl = document.getElementById('search-results');
  if (!q || !DATA) { resultsEl.classList.remove('open'); return; }
  const matches = DATA.tickers.filter(t => t.ticker.includes(q));
  if (!matches.length) { resultsEl.classList.remove('open'); return; }
  resultsEl.innerHTML = matches.map(t =>
    `<span class="search-tag" onclick="openModal('${t.ticker}');document.getElementById('search').value='';document.getElementById('search-results').classList.remove('open')">${t.ticker} <span style="color:var(--muted)">${t.daily_ret>=0?'+':''}${fmt(t.daily_ret)}%</span></span>`
  ).join('');
  resultsEl.classList.add('open');
});
document.addEventListener('click', e => {
  if (!e.target.closest('#search') && !e.target.closest('#search-results'))
    document.getElementById('search-results').classList.remove('open');
});

// MODAL
function openModal(ticker) {
  const t = DATA.tickers.find(x => x.ticker === ticker);
  if (!t) return;
  currentTicker = ticker;
  document.getElementById('modal-ticker').textContent = ticker;
  document.getElementById('modal-price').textContent = `$${fmt(t.close_last)}`;
  const ret = document.getElementById('modal-ret');
  const sign = t.daily_ret >= 0 ? '+' : '';
  ret.textContent = `${sign}${fmt(t.daily_ret)}%`;
  ret.className = 'modal-ret ' + (t.daily_ret > 0 ? 'pos' : t.daily_ret < 0 ? 'neg' : '');
  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderModalChart();
}

document.getElementById('modal-close').addEventListener('click', closeModal);
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
});
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.querySelectorAll('.modal-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    currentTab = this.dataset.tab;
    renderModalChart();
  });
});

document.querySelectorAll('.range-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentDays = parseInt(this.dataset.days);
    renderModalChart();
  });
});

function renderModalChart() {
  if (!currentTicker) return;
  const t = DATA.tickers.find(x => x.ticker === currentTicker);
  if (!t) return;
  let hist = t.history;
  if (currentDays < 99999) {
    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - currentDays);
    hist = hist.filter(h => new Date(h.date) >= cutoff);
  }
  const dates = hist.map(h => h.date);

  let traces = [];
  if (currentTab === 'candles') {
    traces = [{
      type: 'candlestick',
      x: dates, open: hist.map(h=>h.open), high: hist.map(h=>h.high),
      low: hist.map(h=>h.low), close: hist.map(h=>h.close),
      increasing: { line: { color: '#22c55e' }, fillcolor: '#22c55e44' },
      decreasing: { line: { color: '#ef4444' }, fillcolor: '#ef444444' },
      name: currentTicker,
    }];
  } else if (currentTab === 'volume') {
    const colors = hist.map((h,i) => i === 0 ? '#3b82f6' : h.close >= hist[i-1].close ? '#22c55e' : '#ef4444');
    traces = [{
      type: 'bar', x: dates, y: hist.map(h=>h.volume),
      marker: { color: colors }, name: 'Volumen',
    }];
  } else {
    const rets = hist.map((h,i) => i === 0 ? 0 : ((h.close/hist[i-1].close)-1)*100);
    traces = [{
      type: 'scatter', mode: 'lines', x: dates, y: rets,
      line: { color: '#3b82f6', width: 1.5 },
      fill: 'tozeroy', fillcolor: '#3b82f611', name: 'Retorno %',
    }];
  }

  Plotly.react('modal-chart', traces, {
    ...PLOTLY_LAYOUT_BASE,
    height: 420,
    margin: { t: 10, r: 20, b: 40, l: 65 },
    xaxis: { ...PLOTLY_LAYOUT_BASE.xaxis, rangeslider: { visible: false } },
  }, { displayModeBar: false, responsive: true });
}

loadData();
</script>
</body>
</html>
